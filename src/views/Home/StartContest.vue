<template>
    <div class="grid grid-cols-1 justify-items-center">
        <svg v-if="!shownAnimation" class="h-60 lg:h-96 w-auto" width="949" height="837" viewBox="0 0 949 837" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M337.506 424.265V665.265H647.506V424.265H337.506ZM607.025 488.714H583.016V464.705H607.025V488.714Z" fill="#3F3D56"/>
            <path d="M360.509 587.508C359.402 589.68 358.237 591.858 357.046 593.981L354.924 592.791C356.1 590.695 357.25 588.547 358.342 586.404L360.509 587.508Z" fill="#3F3D56"/>
            <path d="M600.653 436.786C600.423 436.411 595.012 427.376 593.136 408.614C591.415 391.402 592.522 362.388 607.569 321.916C636.075 245.245 600.999 183.383 600.641 182.767L602.371 181.763C602.462 181.919 611.513 197.692 616.86 222.807C623.924 256.104 621.352 290.726 609.444 322.613C580.987 399.153 602.143 435.387 602.36 435.744L600.653 436.786Z" fill="#3F3D56"/>
            <path d="M589.506 178.265C596.686 178.265 602.506 172.444 602.506 165.265C602.506 158.085 596.686 152.265 589.506 152.265C582.326 152.265 576.506 158.085 576.506 165.265C576.506 172.444 582.326 178.265 589.506 178.265Z" fill="#00B0FF"/>
            <path d="M630.506 226.265C637.686 226.265 643.506 220.444 643.506 213.265C643.506 206.085 637.686 200.265 630.506 200.265C623.326 200.265 617.506 206.085 617.506 213.265C617.506 220.444 623.326 226.265 630.506 226.265Z" fill="#3F3D56"/>
            <path d="M602.506 258.265C609.686 258.265 615.506 252.444 615.506 245.265C615.506 238.085 609.686 232.265 602.506 232.265C595.326 232.265 589.506 238.085 589.506 245.265C589.506 252.444 595.326 258.265 602.506 258.265Z" fill="#00B0FF"/>
            <path d="M636.506 285.265C643.686 285.265 649.506 279.444 649.506 272.265C649.506 265.085 643.686 259.265 636.506 259.265C629.326 259.265 623.506 265.085 623.506 272.265C623.506 279.444 629.326 285.265 636.506 285.265Z" fill="#00B0FF"/>
            <path d="M592.506 327.265C599.686 327.265 605.506 321.444 605.506 314.265C605.506 307.085 599.686 301.265 592.506 301.265C585.326 301.265 579.506 307.085 579.506 314.265C579.506 321.444 585.326 327.265 592.506 327.265Z" fill="#3F3D56"/>
            <path d="M608.506 437.265C608.506 437.265 595.506 405.265 634.506 381.265L608.506 437.265Z" fill="#3F3D56"/>
            <path d="M592.518 436.684C592.518 436.684 586.602 402.655 540.81 402.947L592.518 436.684Z" fill="#3F3D56"/>
            <path d="M429.586 171.09C446.314 171.09 459.874 157.529 459.874 140.801C459.874 124.074 446.314 110.513 429.586 110.513C412.858 110.513 399.297 124.074 399.297 140.801C399.297 157.529 412.858 171.09 429.586 171.09Z" fill="#A0616A"/>
            <path d="M408.762 155.315C408.762 155.315 418.859 178.031 404.976 186.865C391.094 195.699 427.693 232.298 427.693 232.298L468.077 189.389C468.077 189.389 446.623 175.507 450.409 152.791L408.762 155.315Z" fill="#A0616A"/>
            <path d="M339.352 251.228L330.517 301.708C330.517 301.708 315.373 331.997 315.373 358.499C315.373 385.001 312.849 390.05 312.849 390.05C312.849 390.05 287.609 440.53 305.277 443.054C322.945 445.578 330.517 391.312 330.517 391.312C330.517 391.312 354.496 331.997 354.496 313.067L370.902 271.42L339.352 251.228Z" fill="#A0616A"/>
            <path d="M522.344 253.752L524.868 297.922C524.868 297.922 533.702 320.639 527.392 361.023L522.344 400.146C522.344 400.146 533.702 444.316 522.344 445.578C510.986 446.84 497.103 417.814 504.676 401.408V387.526C504.676 387.526 497.103 328.211 499.628 318.115L490.793 270.158L522.344 253.752Z" fill="#A0616A"/>
            <path d="M358.282 603.33L370.902 636.142L398.666 631.094L380.998 595.758L358.282 603.33Z" fill="#A0616A"/>
            <path d="M478.173 629.832L474.387 677.789H505.937L504.675 636.142L478.173 629.832Z" fill="#A0616A"/>
            <path d="M378.474 342.093L374.688 361.023C374.688 361.023 367.116 367.333 367.116 373.643C367.116 379.953 364.592 382.477 364.592 382.477C364.592 382.477 363.33 382.477 362.068 385.001C361.416 386.38 360.566 387.655 359.544 388.787C359.544 388.787 285.085 464.508 301.491 502.369C317.897 540.229 349.448 617.212 349.448 617.212C349.448 617.212 386.046 605.854 386.046 597.02L350.71 497.321L421.383 424.124L478.173 501.107C478.173 501.107 466.815 636.143 474.387 637.405C481.959 638.667 523.606 647.501 524.868 643.715C526.13 639.929 532.44 472.081 529.916 465.771C527.392 459.46 490.793 383.74 490.793 383.74C490.793 383.74 497.104 376.167 493.317 373.643C489.531 371.119 483.221 347.141 483.221 347.141C483.221 347.141 384.784 330.735 378.474 342.093Z" fill="#2F2E41"/>
            <path d="M432.741 200.747L407.303 185.058C407.303 185.058 392.356 185.603 388.57 189.389C384.784 193.175 362.068 203.271 362.068 203.271C362.068 203.271 367.116 354.713 377.212 349.665C387.308 344.617 379.736 340.831 387.308 344.617C394.88 348.403 484.483 349.665 485.745 349.665C487.007 349.665 488.269 347.141 488.269 347.141L493.317 270.158L509.724 205.795L461.152 183.447L432.741 200.747Z" fill="#D0CDE1"/>
            <path d="M372.164 202.009H362.068C362.068 202.009 348.186 205.795 341.876 225.988C335.565 246.18 333.041 255.014 335.565 257.538C338.09 260.062 372.164 278.992 372.164 278.992V202.009Z" fill="#D0CDE1"/>
            <path d="M492.055 204.533L509.724 205.795C509.724 205.795 532.44 258.8 526.13 261.324C519.82 263.848 483.221 282.778 483.221 278.992C483.221 275.206 492.055 204.533 492.055 204.533Z" fill="#D0CDE1"/>
            <path d="M373.426 619.736L363.136 615.95L339.352 647.501C339.352 647.501 295.181 679.051 335.566 677.789C335.566 677.789 367.116 672.741 369.64 663.907C369.64 663.907 406.238 653.811 406.238 647.501C406.238 641.191 397.828 624.369 395.092 623.946C392.356 623.522 380.998 628.57 373.426 619.736Z" fill="#2F2E41"/>
            <path d="M505.938 663.907C505.938 663.907 475.257 663.408 475.453 664.289C475.649 665.169 466.815 685.361 468.077 692.933C469.339 700.505 480.697 710.602 478.173 715.65C475.649 720.698 485.745 735.842 505.938 737.104C526.13 738.366 523.606 715.65 523.606 715.65L513.51 691.671L505.938 663.907Z" fill="#2F2E41"/>
            <path d="M411.015 105.744C409.5 107.034 407.918 108.244 406.277 109.369C404.208 111.086 402.297 112.985 400.566 115.043L398.613 117.229C396.951 119.09 395.187 121.214 395.258 123.707C395.284 124.633 395.568 125.531 395.679 126.45C396.121 130.095 393.893 134.102 395.727 137.284C396.258 138.203 397.078 138.923 397.662 139.809C398.406 140.945 398.736 142.302 398.595 143.653C400.566 143.734 402.183 141.967 402.802 140.094C403.42 138.22 403.336 136.197 403.637 134.247C403.938 132.297 404.784 130.233 406.555 129.365C410.335 127.513 414.676 132.328 418.71 131.128C421.527 130.29 423.013 126.798 425.893 126.213C427.954 125.794 429.939 127.018 431.855 127.886C433.771 128.754 436.354 129.156 437.709 127.547C438.606 126.482 438.701 124.775 439.891 124.051C441.317 123.183 443.103 124.391 444.182 125.664C445.262 126.937 446.454 128.494 448.123 128.447C450.336 128.386 452.031 125.438 454.132 126.137C456.504 126.927 455.413 130.721 456.852 132.765C458.068 134.492 460.615 134.391 462.709 134.105C463.062 134.141 463.418 134.087 463.745 133.947C464.071 133.808 464.357 133.588 464.575 133.308C464.793 133.028 464.937 132.698 464.992 132.347C465.048 131.997 465.014 131.638 464.893 131.304L464.018 119.708C464.015 118.909 463.84 118.12 463.506 117.394C462.897 116.291 461.636 115.732 460.779 114.809C458.976 112.868 459.063 109.466 456.821 108.054C455.657 107.322 454.135 107.344 452.979 106.598C451.497 105.641 451.02 103.726 449.982 102.3C448.498 100.262 445.903 99.3164 443.395 99.057C440.886 98.7977 438.355 99.1105 435.834 99.0283C430.71 98.8611 425.586 97.419 420.437 98.2632C415.944 98.9999 414.058 102.812 411.015 105.744Z" fill="#2F2E41"/>
        </svg>
        <div v-else class="h-60 lg:h-96 text-gray-500 text-7xl font-semibold">
              <div class="flex h-full justify-center items-center">
                {{ this.nameChange }}
            </div>
        </div>
        <div class="pb-14 font-bold text-center justify-items-center">
            <div class="text-xl">Participantes en el sorteo</div>
            <div class="text-6xl">{{ new Intl.NumberFormat('en-US').format(contestants.length) }}</div>
            <div v-if="0 != this.settings.limit" class="text-md text-gray-500 font-medium">Limite de ganadores: {{ this.settings.limit }} </div>
        </div>
        <div class="space-x-8">
            <secondary-button @click.native="reset" :class="{ 'opacity-25': !contestants.length }"  :disabled="!contestants.length">
                Reiniciar
            </secondary-button>
            <primary-button @click.native="nameAnimation" :class="{ 'opacity-25': !contestants.length || !canSelectMoreWinners }"  :disabled="!contestants.length || !canSelectMoreWinners">
                Iniciar
            </primary-button>
        </div>
    </div>
</template>

<script>
import { mapGetters, mapActions } from 'vuex'
import PrimaryButton from '../../components/Button';
import SecondaryButton from '../../components/SecondaryButton';

export default {
    components: {
        PrimaryButton,
        SecondaryButton
    },

    data() {
        return {
            shownAnimation: false,
            nameChange: null,
        }
    },

    methods: {
        ...mapActions([
            'chooseWinner'
        ]),

        nameAnimation() {
            if (! this.canSelectMoreWinners) {
                return    
            }

            let startTime;
            let fps = this.settings.fps;
            let now;
            let then = Date.now();
            let interval = 1000 / fps;
            let delta;

            const spin = (timestamp, duration) => {
                timestamp = timestamp || new Date().getTime();
                let runTime = timestamp - startTime;

                // check if run time is met
                if (runTime < duration) {
                    requestAnimationFrame((timestamp) => {
                        spin(timestamp, duration);
                    });
                } else {
                    this.chooseWinner();
                    this.shownAnimation = false;
                }

                now = Date.now();
                delta = now - then;

                if (delta > interval) {
                    then = now - (delta % interval);
                    this.nameChange = this.contestants[Math.floor(Math.random() * this.contestants.length)];
                }
            }
            
            this.shownAnimation = true;

            requestAnimationFrame((timestamp) => {
                startTime = timestamp || new Date().getTime();
                spin(startTime, this.settings.duration);
            });
        },

        reset() {
           if (!confirm("¿Estás seguro de que quieres reiniciar el sorteo?")) {
               return;
           }
           
           this.$store.commit('resetWinners', []);
           this.$store.dispatch('updateContestants');
        },
    },

    computed: {
        ...mapGetters([
            'contestants',
            'winners',
            'settings'
        ]),

        canSelectMoreWinners() {
            if (0 == this.settings.limit) {
                return true;
            }

            return this.winners.length >= this.settings.limit
                ? false
                : true;
        }
    }
}
</script>